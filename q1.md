# HQL 1

### 找出所有科目成绩都大于某一学科平均成绩的学生

| uid  | subject_id | score |
| ---- | ---------- | ----- |
| 1001 | 01         | 90    |
| 1001 | 02         | 90    |
| 1001 | 03         | 90    |
| 1002 | 01         | 85    |
| 1002 | 02         | 85    |
| 1002 | 03         | 70    |
| 1003 | 01         | 70    |
| 1003 | 02         | 70    |
| 1003 | 03         | 85    |

### S1 求出每个学科的平均成绩

```sql
select uid, score, avg(score) over(partition by subject_id) avg_score
from score; t1
```

| uid  | score | avg_score                 |
| ---- | ----- | ------------------------- |
| 1001 | 90    | (90 + 85 + 70) / 3 = 81.6 |
| 1001 | 90    | (90 + 85 + 70) / 3 = 81.6 |
| 1001 | 90    | (90 + 70 + 85) / 3= 81.6  |
| 1002 | 85    | 81.6                      |
| 1002 | 85    | 81.6                      |
| 1002 | 70    | 81.6                      |
| 1003 | 70    | 81.6                      |
| 1003 | 70    | 81.6                      |
| 1003 | 85    | 81.6                      |

**窗口函数**：针对每一条记录开窗，以列为作用范围，在每一条记录上作用聚合函数统计同一窗口内的数据

### S2 根据是否大于平均成绩记录flag，大于记为0，否则记为1

```sql
select uid if(score > avg_score,0,1) flag
from t1; t2
```

| uid  | flag |
| ---- | ---- |
| 1001 | 0    |
| 1001 | 0    |
| 1001 | 0    |
| 1002 | 0    |
| 1002 | 0    |
| 1002 | 1    |
| 1003 | 1    |
| 1003 | 1    |
| 1003 | 0    |

### S3 根据学生id进行分组统计flag的和，和为0则所有学科都大于平均成绩

```sql
select uid
from t2
group by uid
having sum(flag) = 0;
```

| uid  |
| ---- |
| 1001 |

